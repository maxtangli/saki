<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Nodoka dev</title>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script>
    var conn = new WebSocket('ws://localhost:8080');
    conn.onopen = init;
    conn.onmessage = receive;

    function init() {
        addLog("Connection established!");

        $("#command").keyup(function(event){
            if(event.keyCode == 13){
                $("#send").click();
            }
        });
    }

    function send(command) {
        conn.send(command);
    }

    function receive(response) {
        var jsonString = response.data;

        addLog(jsonString);

        var view = new View('gui');
        view.render(jsonString);
    }

    function addLog(text) {
        var log = $('#log');
        var newVal = log.val() + text + '\n\n';
        log.val(newVal);

        log.prop('scrollTop', log.prop('scrollHeight'));
    }

    function clearLog() {
        $('#log').val('');
    }

    View = function (divID) {
        this.div = $('#' + divID);
        return this;
    };

    View.prototype = {
        render: function (jsonString) {
            var data = JSON.parse(jsonString);
            if (data.result != 'ok') {
                return;
            }

            this.div.html(this.allView(data));
        },

        allView: function (data) {
            return this.roundView(data.round) + '<br/>'
                    + this.areasView(data.areas) + '<br/>';
        },

        roundView: function (round) {
            return 'Round<br/>'
                    + 'prevailing:' + round.prevailing + '<br/>'
                    + 'phase:' + round.phase + '<br/>'
                    + 'result:' + round.result + '<br/>';
        },

        areasView: function (areas) {
            return areas.map(this.areaView, this).join('');
        },

        areaView: function (area) {
            return area.actor
                    + this.spaceView() + area.point + '<br/>'
                    + 'discard:' + this.tilesView(area.discard) + '<br/>'
                    + 'target:' + this.targetView(area.target) + '<br/>'
                    + 'hand:' + this.tilesView(area.public)
                    + this.spaceView() + this.meldedView(area.melded, this) + '<br/>'
                    + this.commandsView(area.commands)
                    + '<br/>';
        },

        handView: function (area) {
            return area.actor
                    + this.spaceView() + area.point + '<br/>'
                    + 'discard:' + this.tilesView(area.discard) + '<br/>'
                    + 'target:' + this.targetView(area.target) + '<br/>'
                    + 'hand:' + this.tilesView(area.public)
                    + this.spaceView() + this.meldedView(area.melded, this);
        },

        tilesView: function (tiles) {
            return tiles.map(this.tileView, this).join('');
        },

        targetView: function (targetTile) {
            return targetTile !== null ? this.tileView(targetTile) : '';
        },

        meldedView: function (melded) {
            var s = '';
            for (var meld of melded) {
                s += this.meldView(meld) + this.spaceView();
            }
            return s;
//            return melded.map(this.meldedView, this).join(this.spaceView);
        },

        meldView: function (meld) {
            return '<input type="button" value="' + meld + '" disabled="true">';
        },

        tileView: function (tile) {
            return '<input type="button" value="' + tile + '" disabled="true">';
        },

        commandsView: function (commands) {
            return 'commands:' + commands.map(this.commandView).join(this.spaceView());
        },

        commandView: function (command) {
            return '<input type="button" value="' + command + '" onclick="send(this.value)">';
        },

        spaceView: function () {
            return '&nbsp;&nbsp;';
        }
    }
</script>

server response log<input type="button" value="clear" onclick="clearLog()"/><br/>
<textarea id="log" style="margin: 0px; width: 596px; height: 250px;"></textarea><br/>
<br/>

free command input<br/>
<input id="command" type="text" value="type command here"/>
<input id="send" type="button" value="send" onclick="send($('#command').val())"/><br/>
<br/>

gui(debug ver)<br/>
<div id="gui"></div>

</body>
</html>