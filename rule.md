# 文档

文档书写标准

- 英文术语以MIL为准，自创者标*。
- 叙述方式适合程序逻辑。

参考资料

- Mahjong International League/Riichi Competition Rules http://mahjong-mil.org/riichirules2016.pdf
- 日本プロ麻雀連盟/競技ルール http://www.ma-jan.or.jp/guide/game_rule.html
- wiki/麻雀のルール https://ja.wikipedia.org/wiki/%E9%BA%BB%E9%9B%80%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%AB

# 规则采用

规则采用标准

- 群众喜闻乐见。
- 常用。
- 简单。

进行规则

- 赤宝牌：有，包括：r5m，r5p，r5s，共3张。
- 里宝牌：有，不可放弃。
- 明杠宝牌：有，成立时即翻。

- 后付：有。
- 食断：有。
- （未实装）食替：无。
- 自摸平和：有。
- 振听立直：有。
- 起和：1番。

役规则

- （未实装）流局满贯：有。
- 地方役：无。
- 人和：有，要求第一次自摸前。
- 累计役满：有，13番以上。
- 累计多倍役满：有，13番以上时，役满倍数为floor(番数/13)。
- 国士无双十三面待：有，双倍役满。
- 四暗刻单骑：有，双倍役满。
- 纯正九宝莲灯：有，双倍役满。

和牌规则

- 两家和：结算。
- 三家和：结算。
- （未实装）包牌：大三元确定，大四喜确定，四杠子确定，大明杠岭上开花。

流局规则

- 荒牌流局：庄家听牌连庄。
- 不听罚符：总计3000点。
- 九种九牌：途中流局，连庄。
- 四风连打：途中流局，连庄。
- 四开杠：途中流局，连庄。
- 四家立直：途中流局，连庄。

终局规则

- 打飞：有，小于0点终局。顺位？
- 点的结算：持点25000返点30000，顺位马10-20。
- 供托：终局时转移给首位。
- 南入：有。？
- 西入：有。？
- 北入：有。？
- 东返：无。？

# 术语

## 牌

- 牌：？定义，分为数牌和字牌两种类别。

- 数牌：牌的两种类别之一，由花色和数值两种元素构成的牌，共27种。
- 花色：数牌的两种构成元素之一，包括：万、饼、索，共3种，分别记为m、p、s。
- 数值：数牌的两种构成元素之一，包括：1、2、3、4、5、6、7、8、9，共9种。
- 老头牌：指数值为1或9的数牌，包括：1m、9m、1p、9p、1s、9s，共6种。

- 字牌：牌的两种类别之一，不含数值的牌，包括：东、南、西、北、中、白、发，共7种。分别记为E、S、W、N、C、P、F。
- 风牌：字牌的两种类别之一，包括：东、南、西、北，共4种。
- 三元牌：字牌的两种类别之一，包括：中、白、发，共3种。

- 幺九牌：老头牌和字牌的总称，包括：1m、9m、1p、9p、1s、9s、东、南、西、北、中、白、发，共16种。

## 牌的组合

- 对子，Pair：2张相同的牌的组合。

- 顺子，Chow：3张花色相同、数值连续的牌的组合。
- 刻子，Pung：3张相同的牌的组合。
- 杠子，Kong：4张相同的牌的组合。
- 面子，Set：顺子、刻子、杠子的总称。

## 局中的牌

- 游戏，Game
- 局，Hand

- 场风，PrevailingWind
- 自风，SeatWind
- 庄家，Dealer
- 闲家，

- 牌墩：Stack
- 山牌，Wall
- 王牌，DeadWall

- 宝牌指示牌，DoraIndicator：
- 宝牌，Dora：
- 里宝牌（*UraDora）：
- 赤宝牌（*RedDora）：
- 宝牌类型役（*DoraTypeYaku）：

- 洗牌，Mix the tiles
- 掷骰，Roll two dice
- 砌牌，Building the wall
- *断牌，Break the wall
- 发牌，The deal

- 巡目，*CircleCount
- 当前自风，*CurrentSeatWind：
- 当前阶段，*CurrentPhase：个人阶段，公共阶段。

- 回合，Turn：（巡目，当前自风）。
- 回合阶段？：（巡目，当前自风，当前阶段）。

- 手牌
- 宣告区，MeldedSets
- 明刻
- 暗刻
- 明杠
- 暗杠

# 流程

## 单局的流程

空阶段
- 进入：1.初始化。
- 离开：1.进入初始阶段。

初始阶段
- 进入：1.各玩家发牌。
- 离开：1.进入庄家的个人阶段。

（当前玩家，是否抽牌）的个人阶段
- 进入：1.荒牌流局判定。2.修改当前玩家。3.等待当前玩家指令。
- 离开：1.进入公共阶段。

系统指令
- 抽牌，Draw：

个人阶段玩家指令
- 打牌，Discard：Round.toPublic()
- 暗杠，ConcealedKong：Round.stayPrivate()
- 加杠，ExtendKong：Round.stayPrivate()
- 立直，Riichi，*Reach：Round.toPublic()
- 九种九牌流局：Round.toOver(Result)
- 自摸和，Tsumo：Round.toOver(Result)

公共阶段
- 进入：1.等待其它玩家指令。
- 离开：1.途中流局判定。2.进入（下一玩家,抽牌）的个人阶段。

公共阶段玩家指令
- 跳过：Round.toPrivate(next player, true) // leavePublic required
- 吃，Chow：Round.toPrivate(act player, false) // leavePublic ?
- 碰，Pung：
- 大明杠，Kong：
- 荣和，Ron：Round.toOver(Result)

结束阶段
- 进入：1.记录结果，修改分数。
- 离开：1.进入空阶段。

### 杠指令

条件
- 有构成杠的牌。
- 场上的杠少于4个。

伪流程（不考虑四开杠，不考虑抢杠）
1. 杠宣言成立：向宣言区添加杠子，翻杠宝牌，杠者补牌
2. a.个人阶段-暗杠、加杠：保持。
   b.公共阶段-大明杠：进入杠者的不摸牌个人阶段。

伪流程（考虑四开杠，不考虑抢杠）
1. a.个人阶段-暗杠、加杠：保持。
   b.公共阶段-大明杠：将postLeave设为加杠逻辑（为避免四开杠判定），进入杠者的不摸牌个人阶段。  
2. 杠宣言成立：向宣言区添加杠子，翻杠宝牌，杠者补牌

流程（考虑四开杠，考虑抢杠）
1. a.个人阶段-暗杠：保持。
   b.个人阶段-加杠：进入抢杠的公共阶段，且postLeave设为加杠逻辑，且下一阶段为杠者的不摸牌不计回合个人阶段。
   c.公共阶段-大明杠：将postLeave设为加杠逻辑（为避免四开杠判定），进入杠者的不摸牌个人阶段。 
2. 杠宣言成立：向宣言区添加杠子，翻杠宝牌，杠者补牌
3. 
 a.kongBySelf ：进入抢杠公共阶段，并设置下一阶段为杠者的不抽牌-不计巡-个人阶段
 b.kongByOther：进入抢杠公共阶段，并设置下一阶段为杠者的不抽牌-计巡-个人阶段
4. 他家轮询抢杠，若和牌本局结束。
5. 离开抢杠公共阶段（途中流局判定）
6. 进入事先设好的同一玩家的个人阶段，不摸牌不计回合数
7. 等待杠者个人指令，岭上开花役有

# 流局的判定

## 荒牌流局，ExhaustiveDraw

进入个人阶段前判定。需要抽牌且牌山不存在牌时流局。

## 途中流局（主动）

玩家指令，

- 九种九牌：见个人阶段指令。

## 途中流局（被动）

公共阶段离开时判定。

种类

- 四风连打：第1巡，打出了4张同样的风牌，不存在吃碰杠宣言。
- 四开杠：场上有4个杠子，且它们属于至少2个玩家。杠指令执行时，在杠者打牌后的公共阶段离开时判定。
- 四家立直：有4家立直。

# 和牌的判定

## 种类

- 荣和
- 自摸和
- 两家和
- 三家和
- 包牌：大三元确定，大四喜确定，四杠子确定，大明杠岭上开花。

## 和牌条件

- 有任意一种牌型。
- 有至少1番（不计宝牌）。
- 非振听。

## 牌型

- 41牌型：有4个面子，有1个对子。
- 七对子牌型：有7个不同的对子。
- 国士无双牌型：只有幺九牌，有所有幺九牌。

## 听牌，Tenpai

## 听牌类型

- 边张
- 嵌张
- 两面
- 单骑
- 地狱单骑
- 空听

## 振听，Furiten

符合其它和牌条件但不允许荣和的情形。

### 公开牌记录（*OpenHistory）

各回合、各玩家的舍牌和加杠牌的记录。用于振听判定。

### 振听目标牌清单（*FuritenTargetTileList）

公共阶段中，听牌玩家的振听目标牌清单是：

- 非两面待听牌时：目标牌。
- 两面待听牌时：涉及该目标牌的 两面待的 所有待牌。

用于振听判定。

## 振听目标牌，*FuritenTargetTile

振听目标牌清单中的牌。

### 振听条件

1.符合其它和牌条件。
2.荣和。注意自摸和不受振听影响。
3.符合以下任一条件

- 舍牌振听，*OpenFuriten：玩家的 公开牌记录中含有 任一振听目标牌。
- 立直振听，*ReachFuriten：玩家的 立直宣言后的 任一公开牌记录中含有 任一振听目标牌。
- 同巡振听，*TemporaryFuriten：玩家的 上一次舍牌回合开始的 任一公开牌记录中含有 任一振听目标牌。注意“同巡”有特殊含义，不是“同一巡目”的意思。

## 立直

## 役种

- 点数，Point：
- 番数，Fan：
- 符数，Minipoint，*Fu：

### 1番役

- 立直：任意牌型，门清，有立直宣告。
- 门清自摸：任意牌型，门清，自摸和。
- 役牌-中：任意牌型，有1个中的刻子或杠子。
- 役牌-白：任意牌型，有1个白的刻子或杠子。
- 役牌-发：任意牌型，有1个发的刻子或杠子。
- 役牌-场风，PrevailingWind：任意牌型，有1个场风的刻子或杠子。
- 役牌-自风，SeatWind：任意牌型，有1个自风的刻子或杠子。
- 断幺九：任意牌型，没有幺九牌。
- 平和：41牌型，门清，有4个顺子，有1个非幺九牌对子，听牌类型是两面待。
- 一杯口：41牌型，门清，有至少2个相同的顺子。
- 一发：任意牌型，门清，有立直宣告，记有效巡区间为“从（立直巡，下家）到（立直巡+1，自家）”，和牌巡在有效巡区间内，有效巡区间内没有吃碰杠宣告。

- 海底捞月：任意牌型，自摸和，目标牌是最后一张牌。最后一回合杠的情况？
- 河底摸鱼：任意牌型，荣和，目标牌是最后一张牌。
- 岭上开花：任意牌型，在自家任意杠宣告后和牌，目标牌是岭上牌。
- 抢杠：任意牌型，在他家加杠宣告后和牌，目标牌是加杠宣告牌。

### 2番役

- 双立直：任意牌型，门清，本局中已经宣告立直，且立直时为第一巡。不记立直。
- 混老头：任意牌型，只有幺九牌。
- 对对和：41牌型，有4个刻子或杠子，有1个对子。
- 三色同顺：41牌型，非门清减1番，有3个不同花色、相同数值的顺子。
- 一气通贯：41牌型，非门清减1番，有任意一种以下3个顺子的集合：123m+456m+789m，或者123p+456p+789p，或者123s+456s+789s。
- 混全带幺九：41牌型，非门清减1番，有至少1个顺子，每个面子和对子都有至少1张幺九牌。
- 三暗刻：41牌型，有3个暗刻。
- 小三元：41牌型，有2个三元牌的刻子或杠子，有1个三元牌对子。
- 三色同刻：41牌型，非门清减1番，有3个不同花色、相同数值的刻子。
- 三杠子：必定41牌型，有3个杠子。
- 七对子：七对子牌型，门清，有7个不同的对子。符数固定为25符。

### 3番役

- 混一色：任意牌型，有至少1张字牌，除字牌外只有同1种花色数牌。
- 纯全带幺九：41牌型，非门清减1番，有至少1个顺子，每个面子和对子都有至少1张老头牌。
- 二杯口：41牌型，门清，有4个顺子，其中有2个相同、另外2个相同且和前2个不同。

### 6番役

- 清一色：任意牌型，只有同1种花色的数牌。

### 役满

- 四暗刻：41牌型，门清，有4个暗刻。
- 国士无双：国士无双牌型，门清。
- 大三元：41牌型，有3个三元牌的刻子或杠子。
- 小四喜：41牌型，有3个风牌的的刻子或杠子，有1个风牌的对子。
- 大四喜：41牌型，有4个风牌的的刻子或杠子。
- 字一色：任意牌型，只有字牌。
- 清老头：任意牌型，只有老头牌。
- 人和：任意牌型。第一巡，不存在吃碰杠宣言，公共阶段，目标玩家舍牌区为空。
- 绿一色：必定41牌型，只有以下牌：2s、3s、4s、6s、8s、发。
- 九莲宝灯：必定41牌型，门清，只有同一种花色的数牌，有1112345678999这13种数牌。
- 四杠子：必定41牌型，有4个杠子。
- 天和：任意牌型。第一巡，不存在吃碰杠宣言，个人阶段，庄家。
- 地和：任意牌型。第一巡，不存在吃碰杠宣言，个人阶段，闲家。

### 双倍役满

- 四暗刻单骑：41牌型，门清，有4个暗刻，单骑听牌。不计四暗刻。
- 国士无双十三面待：国士无双牌型，门清。目标牌是持有数为2的牌。不计国士无双。
- 纯正九莲宝灯：必定41牌型，门清，只有同一种花色的数牌，手牌除去目标牌后有1112345678999这13种数牌。不计九莲宝灯。